name: Publish Python ðŸ distributions ðŸ“¦ to PyPI and TestPyPI

on: push

env:
  TWINE_USERNAME: mikados
  TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}

jobs:
  build_wheels:
    name: Build Python ðŸ wheels
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        submodules: recursive
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"
    - name: Install pypa/build
      run: >-
        python3 -m
        pip install
        build
        --user
    - name: Build manylinux python wheels
      uses: RalfG/python-wheels-manylinux-build@v0.7.1-manylinux2014_x86_64
      with:
        python-versions: 'cp310-cp310'
        build-requirements: 'cython numpy'   

    - uses: actions/upload-artifact@v3
      with:
        path: dist/*-manylinux*.whl

  build_sdist:
    name: Build Python ðŸ source distribution
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        submodules: recursive
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"
    - name: Install pypa/build
      run: >-
        python3 -m
        pip install
        build
        --user
    - name: Build a source distribution
      run: >-
        python3 -m
        build
        --sdist
        --outdir dist/
    - uses: actions/upload-artifact@v3
      with:
        path: dist/*.tar.gz

  Upload-PyPi:
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    steps: 
      - uses: actions/download-artifact@v3
        with:
          name: artifact
          path: dist
      - name: Publish wheels and source distribution to PyPi
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository-url: https://test.pypi.org/legacy/
